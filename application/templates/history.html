{% extends 'layout.html' %}

<!-- health background img (source: https://www.vecteezy.com/free-vector/medical-background) -->
{% set background_image = 'images/health_bg.jpg' %}

{% block content %}
    <h2>Health Prediction History</h2>

    <!-- If no predictions, display a message and link to create a new prediction -->
    {% if not predictions %}
        <!-- Add a dynamic greeting message with the username -->
        <div class="no-history-container">
            <p class="intro-text">Hello, {{ username }}!</p>
            <p class="no-history-message">It looks like you have no history yet.</p>
            <p><a href="{{ url_for('predict') }}" class="create-prediction-link">Create a new prediction?</a></p>
        </div>
    {% else %}
        <p class="intro-text">Hello, {{ username }}! Below is your personal health prediction history:</p>
        <div class="history">
            <table class="table table-bordered">
                <thead>
                    <tr>
                        <th></th>
                        <th>ID</th>
                        <th>Age</th>
                        <th>BMI</th>
                        <th>Gender</th>
                        <th>Children</th>
                        <th>Smoker</th>
                        <th>Region</th>
                        <th>Health Insurance</th>
                        <th>Timestamp</th>
                        <th></th>
                    </tr>
                </thead>
                <tbody>
                    {% set offset = (page - 1) * 5 %} <!-- Calculate the offset based on the page number -->

                    {% for prediction in predictions %}
                        <tr class="{% if prediction.id == updated_id %}highlight-row{% endif %}">
                            <td>
                                <form action="{{ url_for('predict') }}" method="GET">
                                    <input type="hidden" name="id" value="{{ prediction.id }}">
                                    <input type="hidden" name="page" value="{{ request.args.get('page', 1) }}"> <!-- Add current page -->
                                    <button type="submit" class="btn btn-edit">Edit</button>
                                </form>
                            </td>
                            <!-- offset to adjust the ID -->
                            <td>{{ offset + loop.index }}</td> <!-- Dynamically display ID based on row position -->
                            <!-- Age column -->
                            <td>{{ prediction.age }}</td>
                            <!-- BMI column -->
                            <td>{{ prediction.bmi }}</td>
                            <!-- Gender column -->
                            <td>{{ prediction.gender }}</td>
                            <!-- Children column -->
                            <td>{{ prediction.children }}</td>
                            <!-- Smoker column -->
                            <td>{{ prediction.smoker }}</td>
                            <!-- Region column -->
                            <td>{{ prediction.region }}</td>
                            <!-- Health Prediction column -->
                            <td class="highlight-column">${{ prediction.prediction }}</td>
                            <!-- Time Predicted on -->
                            <td>{{ prediction.predicted_on.strftime("%d %b %y %H:%M") }}</td>
                            <td>
                                <form action="{{ url_for('delete_prediction') }}" method="POST" style="display:inline;">
                                    <input type="hidden" name="id" value="{{ prediction.id }}">
                                    <!-- Protect against accidental delete (2 step verify) -->
                                    <button 
                                        type="submit" 
                                        class="btn btn-sm no-border" 
                                        onclick="return confirm('Are you sure you want to delete this prediction?');">
                                        Delete
                                    </button>
                                </form>
                            </td>
                        </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

        <!-- Pagination controls -->
        <div class="pagination">
            <!-- First page link -->
            <a href="{{ url_for('history', page=1, updated_id=updated_id) }}" class="first-arrow">First</a>
            <!-- Previous page link -->
            <a href="{{ url_for('history', page=prev_url, updated_id=updated_id) }}" class="prev-arrow">← Previous</a>
            <!-- Next page link -->
            <a href="{{ url_for('history', page=next_url, updated_id=updated_id) }}" class="next-arrow">Next →</a>
            <!-- Last page link -->
            <a href="{{ url_for('history', page=latest_page, updated_id=updated_id) }}" class="last-arrow">Last</a>
        </div>
    {% endif %}

    <!-- Floating Action Button -->
    <div class="fab-container">
        <form action="{{ url_for('predict') }}" method="GET">
            <!-- Include the latest page number as a hidden input -->
            <input type="hidden" name="page" value="{{ latest_page }}">
            <button type="submit" class="fab btn" title="Create new prediction">+</button>
        </form>
    </div>
{% endblock %}
